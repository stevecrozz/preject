{% load static %}
{% get_static_prefix as STATIC_PREFIX %}
<!doctype html>
<html lang=en>
  <head>
    <meta charset=utf-8>
    <title>Preject</title>
    <style>
      body { font-family: sans-serif; font-size: 13px; }
      form label { display:block; float:left; width: 200px; }
      form input[type=text], form textarea, form input[type=password] { width: 300px; margin: 0; padding: 0;}
      form ul { list-style-type: none; padding: 0; margin: 0; width: 520px; }
      form ul.errorlist { color: red; }
      form li { margin: 5px 0; }
      form .actions input { float: left; }
      form .actions input { margin-left: 5px; }
      form .actions input:first-of-type { margin-left: 200px; }
      nav ul { list-style-type: none; margin: 0; padding: 0;}
      nav li { display: inline; }
      .alpha { width: 650px; float: left; margin-right: 40px; }
      .beta { float: left; width: 450px; }
      .pile { list-style-type: none; margin: 0; padding: 0; }
      .pile li { cursor: pointer; padding: 5px; }
      .pile .ui-state-highlight { height: 20px; }
      .project-detail textarea { width: 100%; min-height: 150px; }
    </style>
    <link type="text/css" href="{{STATIC_PREFIX}}jquery-ui/css/le-frog/jquery-ui-1.8.14.custom.css" rel="Stylesheet" />
    <script type="text/javascript" src="{{STATIC_PREFIX}}jquery-ui/js/jquery-1.5.1.min.js"></script>
    <script type="text/javascript" src="{{STATIC_PREFIX}}jquery-ui/js/jquery-ui-1.8.14.custom.min.js"></script>
    <script src="{{SHAREJS_URL}}/socket.io/socket.io.js"></script>
    <script src="{{SHAREJS_URL}}/share/share.uncompressed.js"></script>
    <script src="{{SHAREJS_URL}}/share/json.js"></script>
    <script type="text/javascript">
      $(document).ready(function(){
        var shareJsConn = null;
        var project = new function(){
          var self = this;
          this.id = null;
          this.rootNode = null;
          this.doc = null;
          this.dirty = false;
          this.onOpenedDeferred = $.Deferred();
          this.onOpened = this.onOpenedDeferred.promise();
          this.render = function(op){
            var createTaskLi = function(id){
              $('<li>', {
                class: 'ui-state-default',
                text: self.doc.snapshot['task:' + id + ':description']
              }).data('taskId', id).appendTo('.pile');
            };
            if (op) {
              for (var i in op) {
                if (op[i].p[0] == 'tasks') {
                  if (op[i].li) {
                    // created new task
                    createTaskLi(op[i].li);
                  }

                  if (op[i].lm) {
                    // sorted the list
                    var findTaskLi = function(tid){
                      var ret = null;
                      $('.pile li').each(function(){
                        var li = $(this);
                        if (li.data('taskId') == tid){
                          ret = li;
                        }
                      });
                      return ret;
                    };

                    function sort(){
                      $('.pile li').each(function(i){
                        if (self.doc.snapshot.tasks[i] != $(this).data('taskId')) {
                          var taskLi = findTaskLi(self.doc.snapshot.tasks[i]);
                          if (taskLi) {
                            $(this).before(taskLi);
                            sort();
                            return false;
                          }
                        }
                      });
                    };
                    sort();
                  }
                }
              }
              // some operation has happened
            } else {
              // brand new project, initialize display
              for (var i in self.doc.snapshot.tasks) {
                var id = self.doc.snapshot.tasks[i];
                createTaskLi(id);
              }
            }
            // render the changes
            self.dirtyOff();
          };
          this.template = {
            schema: 1,
            description: '',
            tasks: []
          };
          this.dirtyOn = function(){
            self.dirty = true;
            self.indicateDirtiness();
          };
          this.dirtyOff = function(){
            self.dirty = false;
            self.indicateDirtiness();
          };
          this.indicateDirtiness = function(){
            // toggle some visual dirtiness indicator
          };
          this.open = function(rootNode, pid){
            self.rootNode = $(rootNode);
            self.id = pid;
            if (shareJsConn === null) {
              shareJsConn = new sharejs.Connection('{{SHAREJS_URL}}/sjs');
            }
            shareJsConn.open('project/' + pid, sharejs.types.json,
              function(doc, error){
              self.doc = doc;
              self.doc.on('change', self.render);
              if (self.doc.created) {
                // create a new project from the template
                doc.submitOp({p:[],od:null,oi:self.template});
              } else {
                self.render();
              }
            });
            self.rootNode.find('form').submit(function(){
              self.addTask($(this).serializeArray());
              return false;
            });
            self.onOpenedDeferred.resolve();
          };
          self.addTask = function(params){
            var tid = (new Date).getTime();
            var description = "";
            $(params).each(function(){
              if (this.name == 'description') {
                description = this.value;
              }
            });
            self.doc.submitOp([
              { p: ['tasks', self.doc.snapshot.tasks.length], li: tid },
              { p: ['task:' + tid + ':description'], oi: '' },
              { p: ['task:' + tid + ':description', 0], si: description }
            ]);
          };
        };

        var task = new function(){
          var self = this;
          this.id = null;
          this.open = function(tid){
            self.id = tid;
            var o = function(){
              $('.project-detail').hide();
              $('.task-detail').show();
              // open the task
            }

            // make sure the project is open
            if (!project.id){
              project.onOpened.done(o);
            } else {
              o();
            }
          };
          this.close = function(){
            $('.project-detail').show();
            $('.task-detail').hide();
          };
        };

        $(".project-detail").each(function(){
          var pid = $(this).data('projectId');
          project.open(this, pid);
        });

        $('nav a').button();
        $('.actions input').button();
        $(".pile li").live('hover', function(){
          $(this).toggleClass('ui-state-hover');
        });
        $(".pile li").live('click', function(){
          var li = $(this);
          li.toggleClass('ui-state-active')
            .siblings('li').removeClass('ui-state-active');
          var a = li.find('a');
          if (li.hasClass('ui-state-active')) {
            var tid = li.data('taskid');
            task.open(tid);
            window.history.pushState({
              selectedTaskId: tid
            }, "", a.attr('href'));
          } else {
            task.close();
            window.history.pushState({
              selectedTaskId: null
            }, "", a.closest('ul').data('project'));
          }
        });
        $(".pile").sortable({
          placeholder: "ui-state-highlight",
          start: function(event, ui){
            ui.item.originalIndex = ui.item.index();
          },
          update: function(event, ui){
            project.doc.submitOp({
              p: ['tasks', ui.item.originalIndex],
              lm: ui.item.index() + 1
            });
          }
        });
        window.onpopstate = function(event){
          if (event.state) { // popped a state
            $('.pile').find('li').removeClass('ui-state-active');
            if (event.state.selectedTaskId === null) {
              task.close();
            } else {
              $('.pile')
                .find('[data-taskId=' + event.state.selectedTaskId + ']')
                .addClass('ui-state-active');
              task.open(event.state.selectedTaskId);
            }
          } else { // no pushState, just a regular page load
            var activeLi = $('.pile').find('li.ui-state-active');
            if (activeLi.length) {
              task.open(activeLi.data('taskid'));
            } else {
              task.close();
            }
          }
        };
      });
    </script>
  </head>
  <body>
    <div class="alpha">
      <nav>{% block context-nav %}{% endblock %}</nav>
      {% block alpha %}{% endblock %}
    </div>
    <div class="beta">{% block beta %}{% endblock %}</div>
  </body>
</html>
